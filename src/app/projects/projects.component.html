<div class="container mt-4">

  <!-- ================= FILTERS ================= -->
  <div class="row mb-3 g-2">
    <div class="col-md-6">
      <input
        type="text"
        class="form-control"
        placeholder="Search by project name..."
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
      />
    </div>

    <div class="col-md-6">
      <select
        class="form-select"
        [(ngModel)]="selectedMonth"
        (change)="applyFilters()"
      >
        <option value="">All Months</option>
        <option *ngFor="let m of months" [value]="m.value">
          {{ m.label }}
        </option>
      </select>
    </div>
  </div>

  <p *ngIf="loading" class="text-center">Loading...</p>

  <div class="accordion" *ngIf="!loading">

    <div
      class="accordion-item mb-2"
      *ngFor="let p of projects; let i = index"
    >

      <!-- ================= HEADER ================= -->
      <h2 class="accordion-header">
        <button
          class="accordion-button collapsed d-flex justify-content-between align-items-center"
          data-bs-toggle="collapse"
          [attr.data-bs-target]="'#p' + i"
        >
          <span class="fw-bold">{{ p.title }}</span>


        </button>
      </h2>

      <!-- ================= BODY ================= -->
      <div class="accordion-collapse collapse" [id]="'p' + i">
        <div class="accordion-body">

          <!-- ================= VIEW MODE ================= -->
          <div *ngIf="editingProjectId !== p._id">

            <p><strong>Created By:</strong> {{ p.createdBy?.name }}</p>
            <p><strong>Project URL:</strong> {{ p.projectURL || '-' }}</p>
            <p><strong>Project Status:</strong>  {{ p.status }}</p>


            <hr>

            <h6>Client</h6>
            <p>{{ p.client?.name }}</p>
            <p>{{ p.client?.email }}</p>
            <p>{{ p.client?.phone }}</p>

            <hr>

            <h6>Financial</h6>
            <p><strong>Total:</strong> {{ p.totalAmount }} EGP</p>
            <p><strong>Expected Payments:</strong> {{ p.expectedPayments }}</p>

            <p class="text-primary">
              <strong>Total Paid:</strong> {{ getTotalPaid(p) }} EGP
            </p>

            <p class="text-success">
              <strong>Remaining:</strong> {{ getRemaining(p) }} EGP
            </p>

            <hr>

            <h6>Dates</h6>
            <p>Start: {{ p.startDate | date }}</p>
            <p>End: {{ p.endDate | date }}</p>



            <hr>

            <h6>Payments</h6>

            <div *ngIf="p.payments?.length; else noPayments">
              <div
                class="border rounded p-2 mb-2"
                *ngFor="let pay of p.payments; let idx = index"
              >
                <p class="fw-bold">Payment #{{ idx + 1 }}</p>
                <p><strong>Amount:</strong> {{ pay.amount }} EGP</p>
                <p><strong>Method:</strong> {{ pay.paymentMethod }}</p>
                <p><strong>Date:</strong> {{ pay.paymentDate | date }}</p>
                <p><strong>Note:</strong> {{ pay.note || '-' }}</p>
              </div>
            </div>

            <ng-template #noPayments>
              <p class="text-muted">No payments yet</p>
            </ng-template>

            <hr>

            <div class="d-flex gap-2">
             <button
  class="btn btn-primary"
  (click)="startEdit(p._id)"
>
  Edit
</button>


              <button
                class="btn btn-danger"
                (click)="openDeleteModal(p._id)"
              >
                Delete
              </button>
            </div>

          </div>

          <!-- ================= EDIT MODE ================= -->
        <div *ngIf="editingProjectId === p._id">

  <form [formGroup]="editForms[p._id]">

    <input class="form-control mb-2" formControlName="title">

    <input class="form-control mb-2" formControlName="clientName">
    <input class="form-control mb-2" formControlName="clientPhone">
    <input class="form-control mb-2" formControlName="clientEmail">

    <input class="form-control mb-2" type="number" formControlName="totalAmount">
    <input class="form-control mb-2" type="number" formControlName="expectedPayments">
    <input class="form-control mb-2" type="date" formControlName="startDate">

    <!-- ✅ STATUS SELECT -->
    <select class="form-select mb-2" formControlName="status">
      <option value="active">Active</option>
      <option value="paused">Paused</option>
      <option value="completed">Completed</option>
    </select>

  </form>

  <div class="d-flex gap-2">
    <button class="btn btn-success" (click)="updateProject(p)">
      Done
    </button>
    <button class="btn btn-secondary" (click)="cancelEdit()">
      Cancel
    </button>
  </div>

</div>


        </div>
      </div>

    </div>
  </div>

  <!-- ================= ADD PROJECT ================= -->
  <hr class="my-4">

  <button
    *ngIf="!showAddForm"
    class="btn button2 w-100"
    (click)="openAddForm()"
  >
    Add Project
  </button>

  <form *ngIf="showAddForm" [formGroup]="addForm" class="mt-3">

    <input class="form-control mb-2" formControlName="title" placeholder="Title">
    <input class="form-control mb-2" formControlName="clientName" placeholder="Client Name">
    <input class="form-control mb-2" formControlName="clientPhone" placeholder="Client Phone">
    <input class="form-control mb-2" formControlName="clientEmail" placeholder="Client Email">
    <input class="form-control mb-2" type="number" formControlName="totalAmount" placeholder="Total Amount">
    <input class="form-control mb-2" type="number" formControlName="expectedPayments" placeholder="Expected Payments">
    <input class="form-control mb-2" type="date" formControlName="startDate">
    <input class="form-control mb-2" type="date" formControlName="endDate">

    <div *ngIf="submitError" class="alert alert-danger">
      {{ submitError }}
    </div>

    <div class="d-flex gap-2">
  <!-- Save -->
  <button
    type="button"
    class="btn button2 w-100"
    (click)="submitAdd()"
    [disabled]="submitLoading"
  >
    <span *ngIf="submitLoading" class="spinner-border spinner-border-sm"></span>
    <span *ngIf="submitSuccess">✓</span>
    <span *ngIf="!submitLoading && !submitSuccess">Save Project</span>
  </button>

  <!-- Cancel -->
  <button
    type="button"
    class="btn btn-outline-secondary w-100"
    (click)="cancelAdd()"
    [disabled]="submitLoading"
  >
    Cancel
  </button>
</div>

  </form>
</div>

<!-- ================= DELETE MODAL ================= -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">Delete Project</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this project?
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>
