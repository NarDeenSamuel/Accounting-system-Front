<div class="row mb-3">
  <div class="col-md-12">
    <select
      class="form-select"
      [(ngModel)]="selectedMonth"
      (change)="applyMonthFilter()"
    >
      <option value="">All Months</option>
      <option *ngFor="let m of months" [value]="m.value">
        {{ m.label }}
      </option>
    </select>
  </div>
</div>

<div class="container mt-4">

  <p *ngIf="loading" class="text-center">Loading...</p>

  <div *ngIf="!loading && expenses.length">

    <h4 class="mb-3">Expenses Invoice</h4>

    <div class="border rounded p-3 mb-3"
         *ngFor="let e of expenses">

      <!-- VIEW -->
      <div *ngIf="editingExpenseId !== e._id">

        <p><strong>Title:</strong> {{ e.title }}</p>
        <p><strong>Amount:</strong> {{ e.amount }} EGP</p>
        <p><strong>Date:</strong> {{ e.expenseDate | date }}</p>
        <p class="text-muted">
          Added by: {{ e.createdBy?.name }}
        </p>

        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary"
                  (click)="startEdit(e._id)">
            Edit
          </button>
          <button class="btn btn-sm btn-danger"
                  (click)="openDeleteModal(e._id)">
            Delete
          </button>
        </div>
      </div>

      <!-- EDIT -->
      <div *ngIf="editingExpenseId === e._id">
        <form [formGroup]="editForms[e._id]">
          <input class="form-control mb-2" formControlName="title">
          <input class="form-control mb-2" type="number" formControlName="amount">
          <input class="form-control mb-2" type="date" formControlName="expenseDate">
        </form>

        <div class="d-flex gap-2">
          <button class="btn btn-success btn-sm"
                  (click)="updateExpense(e)">
            Done
          </button>
          <button class="btn btn-secondary btn-sm"
                  (click)="cancelEdit()">
            Cancel
          </button>
        </div>
      </div>

    </div>

    <!-- TOTAL -->
    <div class="border-top pt-3 text-end fw-bold">
      Total Expenses: {{ getTotalExpenses() }} EGP
    </div>

    <button class="btn button w-100 mt-3"
            (click)="openAddModal()">
      Add Expense
    </button>

  </div>

  <p *ngIf="!loading && !expenses.length"
     class="text-center text-muted">
    No expenses found
  </p>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="deleteModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <p>Are you sure you want to delete this expense?</p>
      <div class="d-flex gap-2">
        <button class="btn btn-secondary w-100"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button class="btn btn-danger w-100"
                (click)="confirmDelete()">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ADD EXPENSE MODAL -->
<div class="modal fade" id="addExpenseModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">

      <form [formGroup]="addForm">
        <input class="form-control mb-2"
               placeholder="Title"
               formControlName="title">

        <input class="form-control mb-2"
               type="number"
               placeholder="Amount"
               formControlName="amount">

        <input class="form-control mb-2"
               type="date"
               formControlName="expenseDate">
      </form>

      <div class="d-flex gap-2">
        <button class="btn btn-success w-100"
                (click)="submitAdd()">
          Add
        </button>
        <button class="btn btn-secondary w-100"
                data-bs-dismiss="modal">
          Cancel
        </button>
      </div>

    </div>
  </div>
</div>
